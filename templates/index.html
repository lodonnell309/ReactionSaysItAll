<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPhone Message Camera App</title>
    <!-- Add Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Your React component -->
    <script type="text/babel">
        function IPhoneMessageApp() {
            const [responseMessage, setResponseMessage] = React.useState("Get Ready...");
            const [originalMessage, setOriginalMessage] = React.useState("How are you feeling today?");
            const [emotion, setEmotion] = React.useState("neutral");
            const [photoTaken, setPhotoTaken] = React.useState(false);
            const videoRef = React.useRef(null);
            const canvasRef = React.useRef(null);

            // Initialize webcam and fetch random message from backend
            React.useEffect(() => {
                // Start webcam
                const startWebcam = async () => {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        if (videoRef.current) {
                            videoRef.current.srcObject = stream;
                        }
                    } catch (err) {
                        console.error("Error accessing webcam:", err);
                    }
                };

                startWebcam();

                // Fetch message from backend
                fetch("/get_message")
                    .then(response => response.json())
                    .then(data => {
                        setResponseMessage(data.message);
                        if (data.original_message) {
                            setOriginalMessage(data.original_message);
                        }
                        if (data.emotion) {
                            setEmotion(data.emotion);
                        }
                        // Set timeout to take photo after message is displayed
                        setTimeout(() => {
                            takeSnapshot();
                        }, 4000); // 4 seconds delay
                    })
                    .catch(error => {
                        console.error("Error fetching message:", error);
                        // Fallback message if fetch fails
                        setResponseMessage("Say cheese! Taking your photo in 4 seconds...");
                        setTimeout(() => {
                            takeSnapshot();
                        }, 4000);
                    });

                return () => {
                    // Clean up video streams when component unmounts
                    if (videoRef.current && videoRef.current.srcObject) {
                        videoRef.current.srcObject.getTracks().forEach(track => track.stop());
                    }
                };
            }, []);

            const takeSnapshot = () => {
                if (videoRef.current && canvasRef.current) {
                    const video = videoRef.current;
                    const canvas = canvasRef.current;
                    const context = canvas.getContext('2d');

                    // Draw the video frame to the canvas
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);

                    // Convert canvas to data URL
                    const imageData = canvas.toDataURL('image/jpeg');

                    setPhotoTaken(true);

                    // Send the captured image to backend
                    fetch('/capture_photo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ image: imageData })
                    })
                    .then(response => {
                        console.log("Photo sent to backend");
                    })
                    .catch(error => {
                        console.error("Error sending photo:", error);
                    });
                }
            };

            return (
                <div className="flex items-center justify-center h-screen bg-gray-100">
                    <div className="flex items-center justify-center gap-8">
                        {/* iPhone frame */}
                        <div className="w-80 h-[600px] bg-black rounded-[40px] p-3 shadow-xl">
                            {/* iPhone screen */}
                            <div className="bg-white h-full w-full rounded-[32px] overflow-hidden relative">
                                {/* Status bar */}
                                <div className="h-7 bg-gray-100 flex justify-between items-center px-5">
                                    <span className="text-xs font-semibold">9:41</span>
                                    <div className="flex items-center gap-1">
                                        <div className="w-4 h-2.5 bg-black rounded-sm"></div>
                                        <div className="w-3 h-3 bg-black rounded-full"></div>
                                    </div>
                                </div>

                                {/* Message app background */}
                                <div className="h-full w-full pt-4 bg-gray-100 flex flex-col">
                                    {/* Received message bubble (from random message generator) */}
                                    <div className="px-4 py-2">
                                        <div className="bg-gray-300 text-black p-3 rounded-t-xl rounded-bl-xl max-w-[80%] mr-auto relative mb-1">
                                            <p className="text-sm">{originalMessage}</p>
                                        </div>
                                        <span className="text-xs text-gray-500 flex justify-start pl-2">
                                            Just now
                                        </span>
                                    </div>

                                    {/* Response message bubble from model */}
                                    <div className="px-4 py-2">
                                        <div className="bg-blue-500 text-white p-3 rounded-t-xl rounded-br-xl max-w-[80%] ml-auto relative mb-1">
                                            <p className="text-sm">{responseMessage}</p>
                                        </div>
                                        <span className="text-xs text-gray-500 flex justify-end pr-2">
                                            Just now
                                        </span>
                                    </div>

                                    {/* Photo and emotion display */}
                                    {photoTaken && (
                                        <div className="absolute bottom-4 left-0 right-0 px-4">
                                            <div className="bg-white rounded-xl shadow-md overflow-hidden">
                                                <canvas
                                                    ref={canvasRef}
                                                    width={320}
                                                    height={240}
                                                    className="w-full h-32 object-cover"
                                                />
                                                {emotion && (
                                                    <div className="bg-gray-100 p-2 text-center">
                                                        <p className="text-sm font-medium">Emotion: <span className="font-bold text-blue-500">{emotion}</span></p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Camera preview (separate from iPhone) */}
                        <div className="bg-black p-2 rounded-xl shadow-md">
                            <div className="text-white text-center text-sm mb-2">Camera Preview</div>
                            <video
                                ref={videoRef}
                                width={320}
                                height={240}
                                autoPlay
                                muted
                                className="rounded-lg"
                            />
                        </div>
                    </div>
                </div>
            );
        }

        // Render the React component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<IPhoneMessageApp />);
    </script>
</body>
</html>